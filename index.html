<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krishi Tap Factory | Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <style>
        :root { --primary: #00f2ff; --bg: #030811; --glass: rgba(255, 255, 255, 0.05); --success: #00ff88; --danger: #ff4b2b; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background: var(--bg); color: #fff; padding: 10px; }
        .glass-card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .nav-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-btn { flex: 1; background: var(--glass); border: 1px solid rgba(255,255,255,0.1); color: #aaa; padding: 12px; border-radius: 10px; cursor: pointer; font-family: 'Orbitron'; font-size: 0.65rem; }
        .nav-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(0, 242, 255, 0.1); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 12px 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left; }
        th { color: var(--primary); font-family: 'Orbitron'; font-size: 0.7rem; }
        input, select { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; margin-top: 8px; }
        .btn-pay { background: var(--success); color: #000; padding: 8px 12px; border-radius: 6px; font-weight: bold; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; font-size: 0.8rem; }
        .btn-done { background: var(--primary); color: #000; padding: 8px; border-radius: 6px; border: none; cursor: pointer; margin-left: 5px; }
        .btn-del { background: none; border: 1px solid var(--danger); color: var(--danger); padding: 5px 10px; border-radius: 6px; cursor: pointer; }
        .section { display: none; }
        .section.active { display: block; }
        #loginOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="glass-card" style="width: 300px;">
        <h2 style="text-align: center; font-family: 'Orbitron'; color: var(--primary); margin-bottom: 15px;">ADMIN</h2>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPass" placeholder="Password">
        <button onclick="login()" style="width:100%; margin-top:15px; padding:12px; background:var(--primary); border:none; cursor:pointer; font-weight:bold; border-radius:8px;">ENTER</button>
    </div>
</div>

<div id="mainSystem" style="display:none;">
    <div class="nav-bar">
        <button class="nav-btn active" onclick="tab('attendance')">ATTENDANCE</button>
        <button class="nav-btn" onclick="tab('workers')">WORKERS</button>
        <button class="nav-btn" onclick="tab('salary')">PAYOUTS</button>
    </div>

    <div id="workers" class="section">
        <div class="glass-card">
            <h3 style="font-family:'Orbitron'; font-size: 1rem; color: var(--primary);">Add Worker</h3>
            <input type="text" id="wName" placeholder="Worker Name">
            <input type="number" id="wBase" placeholder="8-Hour Salary (₹)">
            <input type="text" id="wUpi" placeholder="UPI ID (e.g. 9876543210@okaxis)">
            <select id="wShift"><option>Day Shift</option><option>Night Shift</option></select>
            <button onclick="saveWorker()" style="width:100%; margin-top:15px; background:var(--primary); padding:12px; border-radius:8px; border:none; font-weight:bold;">SAVE TO DATABASE</button>
        </div>
        <div class="glass-card">
            <h3 style="font-family:'Orbitron'; margin-bottom:10px;">Worker List</h3>
            <div style="overflow-x:auto;">
                <table id="workerTable">
                    <thead><tr><th>Name</th><th>Shift</th><th>Action</th></tr></thead>
                    <tbody id="workerListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="attendance" class="section active">
        <div class="glass-card" style="overflow-x:auto;">
            <h3 style="font-family:'Orbitron'; margin-bottom:10px;">Weekly Hours</h3>
            <table>
                <thead><tr><th>Name</th><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr></thead>
                <tbody id="attendanceGrid"></tbody>
            </table>
        </div>
    </div>

    <div id="salary" class="section">
        <div class="glass-card">
            <h3 style="font-family:'Orbitron'; margin-bottom:15px;">Pending Payments</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Worker</th><th>Hrs</th><th>Amount</th><th>Pay Action</th></tr></thead>
                    <tbody id="salaryBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD1GoChSmMELhRjxYHgJiJq3F85dldINGE",
        authDomain: "tap-tap-eae08.firebaseapp.com",
        projectId: "tap-tap-eae08",
        storageBucket: "tap-tap-eae08.firebasestorage.app",
        messagingSenderId: "734680519369",
        appId: "1:734680519369:web:6d7a0cd549aa31c6277318"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    function tab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        if(id === 'workers') loadWorkers();
        if(id === 'attendance') loadAttendance();
        if(id === 'salary') loadSalary();
    }

    function login() {
        const e = document.getElementById('loginEmail').value;
        const p = document.getElementById('loginPass').value;
        auth.signInWithEmailAndPassword(e, p).catch(err => alert("Login Error: " + err.message));
    }

    auth.onAuthStateChanged(user => {
        if(user) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            loadAttendance();
        }
    });

    // --- WORKER LOGIC ---
    async function saveWorker() {
        const name = document.getElementById('wName').value;
        const base = document.getElementById('wBase').value;
        const upi = document.getElementById('wUpi').value;
        const shift = document.getElementById('wShift').value;
        if(!name || !base || !upi) return alert("Fill all fields including UPI");
        await db.collection("workers").add({ name, baseSalary: parseFloat(base), upi, shift });
        alert("Worker Added Successfully");
        tab('workers');
    }

    async function loadWorkers() {
        const snap = await db.collection("workers").get();
        const body = document.getElementById('workerListBody');
        body.innerHTML = "";
        snap.forEach(doc => {
            const w = doc.data();
            body.innerHTML += `<tr>
                <td><b>${w.name}</b></td>
                <td>${w.shift}</td>
                <td><button class="btn-del" onclick="deleteWorker('${doc.id}')">Delete</button></td>
            </tr>`;
        });
    }

    async function deleteWorker(id) {
        if(confirm("Confirm Delete Worker?")) {
            await db.collection("workers").doc(id).delete();
            loadWorkers();
        }
    }

    // --- ATTENDANCE LOGIC ---
    async function loadAttendance() {
        const wSnap = await db.collection("workers").get();
        const grid = document.getElementById('attendanceGrid');
        grid.innerHTML = "";
        wSnap.forEach(doc => {
            const w = doc.data();
            let inputs = "";
            for(let i=0; i<7; i++) {
                inputs += `<td><input type="number" id="h-${doc.id}-${i}" placeholder="0" style="width:45px; padding:5px; margin:0;" onchange="saveHrs('${doc.id}')"></td>`;
            }
            grid.innerHTML += `<tr><td>${w.name}</td>${inputs}</tr>`;
            loadSavedHrs(doc.id);
        });
    }

    async function saveHrs(workerId) {
        let hrs = [];
        for(let i=0; i<7; i++) hrs.push(document.getElementById(`h-${workerId}-${i}`).value || 0);
        await db.collection("weekly_att").doc(workerId).set({ hours: hrs });
    }

    async function loadSavedHrs(workerId) {
        const doc = await db.collection("weekly_att").doc(workerId).get();
        if(doc.exists) {
            doc.data().hours.forEach((h, i) => {
                const el = document.getElementById(`h-${workerId}-${i}`);
                if(el) el.value = h;
            });
        }
    }

    // --- SALARY & UPI PAY LOGIC ---
    async function loadSalary() {
        const wSnap = await db.collection("workers").get();
        const aSnap = await db.collection("weekly_att").get();
        const pSnap = await db.collection("payments").get();
        
        let attMap = {}; aSnap.forEach(d => attMap[d.id] = d.data().hours);
        let paidMap = {}; pSnap.forEach(d => paidMap[d.id] = true);
        
        const body = document.getElementById('salaryBody');
        body.innerHTML = "";

        wSnap.forEach(doc => {
            const w = doc.data();
            const hrs = attMap[doc.id] || [0,0,0,0,0,0,0];
            const totalHrs = hrs.reduce((a, b) => parseFloat(a) + parseFloat(b), 0);
            const amount = (totalHrs * (parseFloat(w.baseSalary || 0) / 8)).toFixed(2);
            
            // UPI Link Structure with Remark
            const remark = encodeURIComponent("KRISHI TAP SALARY");
            const upiLink = `upi://pay?pa=${w.upi}&pn=${encodeURIComponent(w.name)}&am=${amount}&cu=INR&tn=${remark}`;
            
            let actionHtml = "";
            if(paidMap[doc.id]) {
                actionHtml = `<span style="color:var(--success); font-weight:bold;">● PAID</span>`;
            } else {
                actionHtml = `
                    <div style="display:flex; align-items:center;">
                        <a href="${upiLink}" class="btn-pay" target="_blank">PAY</a>
                        <button class="btn-done" title="Mark as Paid" onclick="markPaid('${doc.id}')">✓</button>
                    </div>
                `;
            }

            body.innerHTML += `<tr>
                <td><b>${w.name}</b></td>
                <td>${totalHrs}h</td>
                <td>₹${amount}</td>
                <td>${actionHtml}</td>
            </tr>`;
        });
    }

    async function markPaid(id) {
        if(confirm("Mark this worker as PAID for this week?")) {
            await db.collection("payments").doc(id).set({ paid: true, timestamp: new Date() });
            loadSalary();
        }
    }
</script>
</body>
</html>
